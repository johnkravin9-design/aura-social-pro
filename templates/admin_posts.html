{% extends "base.html" %}

{% block title %}Post Management - Admin - Aura Social{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 pt-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="glass rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white">üìù Post Management</h1>
                    <p class="text-purple-300 mt-2">Moderate platform content</p>
                </div>
                <a href="/admin" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all">
                    ‚Üê Dashboard
                </a>
            </div>
        </div>

        <div class="glass rounded-2xl p-6">
            <h2 class="text-2xl font-bold text-white mb-6">All Posts</h2>
            <div id="postsContainer" class="space-y-4">
                <!-- Posts will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
async function loadPosts() {
    try {
        const response = await fetch('/api/admin/posts');
        const posts = await response.json();
        
        const container = document.getElementById('postsContainer');
        container.innerHTML = posts.map(post => `
            <div class="glass rounded-2xl p-6 ${post.is_approved ? '' : 'border-2 border-orange-500'}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold">
                            ${post.username.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="text-white font-semibold">${post.username}</div>
                            <div class="text-purple-300 text-sm">${post.timestamp}</div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${post.is_approved ? 'bg-green-500' : 'bg-orange-500'} text-white">
                            ${post.is_approved ? 'Approved' : 'Pending'}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-500 text-white">
                            ${post.likes} üëç
                        </span>
                        ${post.reports > 0 ? `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-500 text-white">${post.reports} üö®</span>` : ''}
                    </div>
                </div>
                
                <p class="text-white mb-4">${post.content}</p>
                
                <div class="flex space-x-2">
                    <button onclick="togglePost('${post.id}')" class="px-4 py-2 ${post.is_approved ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded transition-colors">
                        ${post.is_approved ? 'Unapprove' : 'Approve'}
                    </button>
                    <button onclick="deletePost('${post.id}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading posts:', error);
        showNotification('Failed to load posts', 'error');
    }
}

async function togglePost(postId) {
    try {
        const response = await fetch(`/api/admin/toggle_post/${postId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`Post ${data.is_approved ? 'approved' : 'unapproved'}`, 'success');
            loadPosts();
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        showNotification('Failed to update post', 'error');
    }
}

async function deletePost(postId) {
    if (confirm('Are you sure you want to delete this post?')) {
        try {
            const response = await fetch(`/api/admin/delete_post/${postId}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Post deleted', 'success');
                loadPosts();
            } else {
                showNotification(data.error, 'error');
            }
        } catch (error) {
            showNotification('Failed to delete post', 'error');
        }
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    const response = await fetch('/api/current_user');
    const user = await response.json();
    
    if (user.error || !user.is_admin) {
        showNotification('Admin access required', 'error');
        setTimeout(() => window.location.href = '/feed', 2000);
        return;
    }
    
    loadPosts();
});
</script>
{% endblock %}
