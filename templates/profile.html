{% extends "base.html" %}

{% block title %}Profile - Aura Social{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Profile Header -->
    <div class="glass rounded-2xl p-8 mb-6">
        <div class="flex items-center space-x-6">
            <div class="relative">
                <div id="userAvatar" class="w-24 h-24 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-4xl aura-glow cursor-pointer" onclick="openAvatarPicker()">
                    👤
                </div>
                <button onclick="openAvatarPicker()" class="absolute -bottom-2 -right-2 bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm hover:bg-purple-600 transition-colors">
                    ✏️
                </button>
            </div>
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-white" id="profileName">Loading...</h1>
                <p class="text-purple-300 text-lg" id="profileUsername">@username</p>
                <p class="text-white mt-2" id="profileBio">This is where your bio will appear. Share your aura with the world!</p>
                
                <div class="flex space-x-6 mt-4">
                    <div class="text-center">
                        <div class="text-white font-bold text-xl" id="profilePosts">0</div>
                        <div class="text-purple-300">Posts</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white font-bold text-xl" id="profileFollowing">0</div>
                        <div class="text-purple-300">Following</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white font-bold text-xl" id="profileFollowers">0</div>
                        <div class="text-purple-300">Followers</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex space-x-4 mt-6">
            <button onclick="editProfile()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all">
                Edit Profile
            </button>
            <button onclick="logout()" class="glass text-white px-6 py-2 rounded-full hover:bg-white/20 transition-all">
                Logout
            </button>
        </div>
    </div>

    <!-- User Posts -->
    <div>
        <h2 class="text-2xl font-bold text-white mb-6">Recent Auras</h2>
        <div id="userPostsContainer" class="space-y-4">
            <div class="glass rounded-2xl p-8 text-center">
                <div class="text-4xl mb-4">🌟</div>
                <h3 class="text-white font-bold text-xl mb-2">No Auras Yet</h3>
                <p class="text-purple-300">Share your first aura to let the world see your glow!</p>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Picker Modal -->
<div id="avatarModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glass rounded-2xl p-6 max-w-md w-full mx-4">
        <h3 class="text-white font-bold text-xl mb-4">Choose Your Avatar</h3>
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="👤">👤</div>
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="😊">😊</div>
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-green-500 to-teal-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="🎨">🎨</div>
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="🚀">🚀</div>
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-pink-500 to-red-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="🌟">🌟</div>
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="💫">💫</div>
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-teal-500 to-blue-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="🎭">🎭</div>
            <div class="avatar-option w-16 h-16 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center text-2xl cursor-pointer hover:scale-110 transition-transform" data-avatar="🔥">🔥</div>
        </div>
        <div class="flex space-x-4">
            <button onclick="closeAvatarPicker()" class="flex-1 glass text-white px-4 py-2 rounded-xl hover:bg-white/20 transition-colors">
                Cancel
            </button>
            <button onclick="saveAvatar()" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all">
                Save Avatar
            </button>
        </div>
    </div>
</div>

<script>
let currentUser = null;
let selectedAvatar = '👤';

async function loadProfile() {
    try {
        const response = await fetch('/api/current_user');
        const user = await response.json();
        
        if (user.error) {
            window.location.href = '/login';
            return;
        }
        
        currentUser = user;
        updateProfile(user);
        loadUserPosts();
    } catch (error) {
        showNotification('Failed to load profile', 'error');
    }
}

function updateProfile(user) {
    document.getElementById('profileName').textContent = user.display_name || user.username;
    document.getElementById('profileUsername').textContent = `@${user.username}`;
    document.getElementById('profileBio').textContent = user.bio || 'This is where your bio will appear. Share your aura with the world!';
    document.getElementById('userAvatar').textContent = user.avatar || '👤';
    
    // Update stats
    document.getElementById('profilePosts').textContent = user.post_count || '0';
    document.getElementById('profileFollowing').textContent = user.following || '0';
    document.getElementById('profileFollowers').textContent = user.followers || '0';
}

function openAvatarPicker() {
    document.getElementById('avatarModal').classList.remove('hidden');
}

function closeAvatarPicker() {
    document.getElementById('avatarModal').classList.add('hidden');
}

function saveAvatar() {
    // Update the avatar display
    document.getElementById('userAvatar').textContent = selectedAvatar;
    
    // Save to backend (we'll implement this in main.py)
    updateUserAvatar(selectedAvatar);
    
    closeAvatarPicker();
    showNotification('Avatar updated successfully! ✨', 'success');
}

// Avatar selection
document.querySelectorAll('.avatar-option').forEach(option => {
    option.addEventListener('click', function() {
        // Remove previous selection
        document.querySelectorAll('.avatar-option').forEach(opt => {
            opt.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-purple-900');
        });
        
        // Add selection to clicked option
        this.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-purple-900');
        selectedAvatar = this.getAttribute('data-avatar');
    });
});

async function updateUserAvatar(avatar) {
    try {
        const response = await fetch('/api/update_avatar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ avatar })
        });
        
        const data = await response.json();
        if (!data.success) {
            showNotification('Failed to update avatar', 'error');
        }
    } catch (error) {
        showNotification('Failed to update avatar', 'error');
    }
}

async function loadUserPosts() {
    try {
        const response = await fetch('/api/user_posts');
        const posts = await response.json();
        renderUserPosts(posts);
    } catch (error) {
        console.error('Error loading user posts:', error);
    }
}

function renderUserPosts(posts) {
    const container = document.getElementById('userPostsContainer');
    
    if (!posts || posts.length === 0) {
        container.innerHTML = `
            <div class="glass rounded-2xl p-8 text-center">
                <div class="text-4xl mb-4">🌟</div>
                <h3 class="text-white font-bold text-xl mb-2">No Auras Yet</h3>
                <p class="text-purple-300">Share your first aura to let the world see your glow!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = posts.map(post => `
        <article class="glass rounded-2xl p-6 post-card">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                        ${currentUser.avatar || '👤'}
                    </div>
                    <div>
                        <p class="text-purple-300 text-sm">${post.timestamp}</p>
                    </div>
                </div>
                <button class="text-purple-300 hover:text-white transition-colors">
                    ⋮
                </button>
            </div>
            <p class="text-white text-lg">${post.content}</p>
            <div class="flex items-center justify-between mt-4 text-purple-300">
                <button class="flex items-center space-x-2 hover:text-pink-400 transition-colors">
                    <span>❤️</span>
                    <span>${post.likes || 0}</span>
                </button>
                <button class="flex items-center space-x-2 hover:text-blue-400 transition-colors">
                    <span>💬</span>
                    <span>${post.comments_count || 0}</span>
                </button>
                <button class="hover:text-white transition-colors">📤</button>
            </div>
        </article>
    `).reverse().join('');
}

function editProfile() {
    showNotification('Profile editing coming soon! ✨', 'info');
}

async function logout() {
    try {
        await fetch('/api/logout');
        showNotification('You have been logged out. Your aura will be missed! 🌟', 'success');
        setTimeout(() => {
            window.location.href = '/';
        }, 1500);
    } catch (error) {
        showNotification('Logout failed', 'error');
    }
}

// Load profile when page opens
loadProfile();
</script>
{% endblock %}
