{% extends "base.html" %}

{% block title %}Messages - Aura Social{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 pt-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Messages Header -->
        <div class="glass rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white">üí¨ Messages</h1>
                    <p class="text-purple-300 mt-2">Chat with your Aura friends</p>
                </div>
                <a href="/feed" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all">
                    ‚Üê Back to Feed
                </a>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="glass rounded-2xl overflow-hidden">
            <div class="flex h-[600px]">
                <!-- Conversations Sidebar -->
                <div class="w-1/3 border-r border-white/20">
                    <div class="p-6 border-b border-white/20">
                        <div class="relative">
                            <input type="text" placeholder="Search conversations..." 
                                   class="w-full px-4 py-3 rounded-xl bg-white/10 text-white placeholder-purple-300 border border-white/20 focus:outline-none focus:border-purple-400 transition-colors">
                            <svg class="w-5 h-5 text-purple-300 absolute right-4 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="overflow-y-auto h-[500px]">
                        <div id="conversationsList" class="p-4 space-y-2">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="flex-1 flex flex-col">
                    <!-- Chat Header -->
                    <div class="p-6 border-b border-white/20 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <div id="chatAvatar" class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-lg">
                                    A
                                </div>
                                <div id="onlineDot" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>
                            <div>
                                <h2 id="chatUserName" class="font-bold text-lg text-white">Select a conversation</h2>
                                <p id="chatStatus" class="text-sm text-purple-300">Choose someone to chat with</p>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Area -->
                    <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 space-y-4">
                        <div class="text-center py-20">
                            <div class="text-6xl mb-4">üí¨</div>
                            <h3 class="text-white font-bold text-xl mb-2">Start a Conversation</h3>
                            <p class="text-purple-300">Select a conversation from the sidebar to start chatting</p>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="p-6 border-t border-white/20">
                        <form id="messageForm" class="flex items-end space-x-4">
                            <div class="flex-1">
                                <textarea id="messageInput" rows="1" placeholder="Type your message..." 
                                          class="w-full px-4 py-3 rounded-xl bg-white/10 text-white placeholder-purple-300 border border-white/20 focus:outline-none focus:border-purple-400 resize-none transition-all"
                                          disabled></textarea>
                            </div>
                            <button type="submit" 
                                    class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversation = null;
let currentUser = null;

// Sample conversations data
const conversations = [
    { 
        id: 1, 
        name: 'Sarah Johnson', 
        avatar: 'S', 
        lastMessage: 'See you tomorrow! üéâ', 
        time: '2m ago', 
        unread: 2, 
        online: true, 
        gradient: 'from-purple-500 to-pink-500' 
    },
    { 
        id: 2, 
        name: 'Mike Chen', 
        avatar: 'M', 
        lastMessage: 'Thanks for the help!', 
        time: '15m ago', 
        unread: 0, 
        online: true, 
        gradient: 'from-blue-500 to-cyan-500' 
    },
    { 
        id: 3, 
        name: 'Emma Wilson', 
        avatar: 'E', 
        lastMessage: 'That sounds great!', 
        time: '1h ago', 
        unread: 0, 
        online: false, 
        gradient: 'from-green-500 to-teal-500' 
    }
];

// Sample messages data
const messagesData = {
    1: [
        { id: 1, text: 'Hey! How are you doing?', sent: false, time: '10:30 AM', read: true },
        { id: 2, text: 'I\'m doing great! Just finished that project we discussed. üéâ', sent: true, time: '10:32 AM', read: true },
        { id: 3, text: 'That\'s awesome! Can you send me the details?', sent: false, time: '10:33 AM', read: true }
    ],
    2: [
        { id: 1, text: 'Hi there! Got a minute?', sent: false, time: '09:15 AM', read: true },
        { id: 2, text: 'Yes, what\'s up?', sent: true, time: '09:16 AM', read: true }
    ],
    3: [
        { id: 1, text: 'Lunch tomorrow?', sent: true, time: 'Yesterday', read: true },
        { id: 2, text: 'Sounds perfect! 12:30?', sent: false, time: 'Yesterday', read: true }
    ]
};

// Load current user
async function loadCurrentUser() {
    try {
        const response = await fetch('/api/current_user');
        const userData = await response.json();
        
        if (!userData.error) {
            currentUser = userData;
        }
    } catch (error) {
        console.error('Error loading user:', error);
    }
}

// Render conversations list
function renderConversations() {
    const container = document.getElementById('conversationsList');
    container.innerHTML = conversations.map(conv => `
        <div class="p-4 rounded-xl hover:bg-white/10 cursor-pointer transition-all ${currentConversation?.id === conv.id ? 'bg-white/20 border border-purple-400' : ''}" 
             onclick="selectConversation(${conv.id})">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br ${conv.gradient} flex items-center justify-center text-white font-bold">
                        ${conv.avatar}
                    </div>
                    ${conv.online ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-semibold text-white truncate">${conv.name}</h3>
                        <span class="text-xs text-purple-300">${conv.time}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-purple-300 truncate">${conv.lastMessage}</p>
                        ${conv.unread > 0 ? `
                            <span class="ml-2 px-2 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs rounded-full font-semibold">
                                ${conv.unread}
                            </span>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Render messages for a conversation
function renderMessages(conversationId) {
    const container = document.getElementById('messagesContainer');
    const messages = messagesData[conversationId] || [];
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-20">
                <div class="text-6xl mb-4">üí¨</div>
                <h3 class="text-white font-bold text-xl mb-2">No messages yet</h3>
                <p class="text-purple-300">Start the conversation by sending a message!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = messages.map(msg => `
        <div class="flex ${msg.sent ? 'justify-end' : 'justify-start'}">
            <div class="max-w-[70%]">
                <div class="${msg.sent ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-white/10 text-white'} rounded-2xl px-4 py-3">
                    <p class="text-sm leading-relaxed">${msg.text}</p>
                </div>
                <div class="flex items-center ${msg.sent ? 'justify-end' : 'justify-start'} mt-1 px-2">
                    <span class="text-xs text-purple-300">${msg.time}</span>
                </div>
            </div>
        </div>
    `).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Select a conversation
function selectConversation(conversationId) {
    currentConversation = conversations.find(conv => conv.id === conversationId);
    
    if (!currentConversation) return;
    
    // Update chat header
    document.getElementById('chatUserName').textContent = currentConversation.name;
    document.getElementById('chatAvatar').textContent = currentConversation.avatar;
    document.getElementById('chatAvatar').className = `w-12 h-12 rounded-full bg-gradient-to-br ${currentConversation.gradient} flex items-center justify-center text-white font-bold text-lg`;
    document.getElementById('chatStatus').textContent = currentConversation.online ? 'Online' : 'Offline';
    document.getElementById('onlineDot').style.display = currentConversation.online ? 'block' : 'none';
    
    // Enable message input
    document.getElementById('messageInput').disabled = false;
    document.getElementById('messageInput').placeholder = 'Type your message...';
    document.querySelector('button[type="submit"]').disabled = false;
    
    // Render messages
    renderMessages(conversationId);
    renderConversations();
}

// Handle message form submission
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentConversation) return;
    
    const messageInput = document.getElementById('messageInput');
    const text = messageInput.value.trim();
    
    if (!text) return;
    
    // Add message to current conversation
    if (!messagesData[currentConversation.id]) {
        messagesData[currentConversation.id] = [];
    }
    
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    
    messagesData[currentConversation.id].push({
        id: messagesData[currentConversation.id].length + 1,
        text: text,
        sent: true,
        time: time,
        read: false
    });
    
    // Clear input
    messageInput.value = '';
    
    // Re-render messages
    renderMessages(currentConversation.id);
    
    // Update conversation last message
    currentConversation.lastMessage = text.length > 30 ? text.substring(0, 30) + '...' : text;
    currentConversation.time = 'Just now';
    currentConversation.unread = 0;
    
    renderConversations();
    
    // Show notification
    if (typeof showNotification === 'function') {
        showNotification('Message sent!', 'success');
    }
});

// Auto-resize textarea
document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentUser();
    renderConversations();
    
    // Auto-select first conversation if available
    if (conversations.length > 0) {
        setTimeout(() => selectConversation(conversations[0].id), 100);
    }
});
</script>
{% endblock %}
