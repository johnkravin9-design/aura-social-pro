{% extends "base.html" %}

{% block title %}User Management - Admin - Aura Social{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 pt-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="glass rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white">üë• User Management</h1>
                    <p class="text-purple-300 mt-2">Manage all platform users</p>
                </div>
                <div class="flex space-x-4">
                    <a href="/admin" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all">
                        ‚Üê Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="glass rounded-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">All Users</h2>
                <div class="text-purple-300" id="usersCount">Loading...</div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="text-left text-white p-4">User</th>
                            <th class="text-left text-white p-4">Email</th>
                            <th class="text-left text-white p-4">Posts</th>
                            <th class="text-left text-white p-4">Status</th>
                            <th class="text-left text-white p-4">Role</th>
                            <th class="text-left text-white p-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        const users = await response.json();
        
        document.getElementById('usersCount').textContent = `${users.length} users`;
        
        const table = document.getElementById('usersTable');
        table.innerHTML = users.map(user => `
            <tr class="border-b border-white/10 hover:bg-white/5">
                <td class="p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="text-white font-semibold">${user.username}</div>
                            <div class="text-purple-300 text-sm">Joined ${new Date(user.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                </td>
                <td class="p-4 text-purple-300">${user.email}</td>
                <td class="p-4 text-white">${user.post_count}</td>
                <td class="p-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${user.is_active ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                        ${user.is_active ? 'Active' : 'Suspended'}
                    </span>
                </td>
                <td class="p-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${user.is_admin ? 'bg-yellow-500 text-white' : 'bg-blue-500 text-white'}">
                        ${user.is_admin ? 'Admin' : 'User'}
                    </span>
                </td>
                <td class="p-4">
                    <div class="flex space-x-2">
                        <button onclick="toggleUser('${user.username}')" class="px-3 py-1 ${user.is_active ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded text-sm transition-colors">
                            ${user.is_active ? 'Suspend' : 'Activate'}
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

    } catch (error) {
        console.error('Error loading users:', error);
        showNotification('Failed to load users', 'error');
    }
}

async function toggleUser(username) {
    try {
        const response = await fetch(`/api/admin/toggle_user/${username}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`User ${data.is_active ? 'activated' : 'suspended'}`, 'success');
            loadUsers(); // Reload the table
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        showNotification('Failed to update user', 'error');
    }
}

// Check admin access and load data
document.addEventListener('DOMContentLoaded', async function() {
    const response = await fetch('/api/current_user');
    const user = await response.json();
    
    if (user.error || !user.is_admin) {
        showNotification('Admin access required', 'error');
        setTimeout(() => window.location.href = '/feed', 2000);
        return;
    }
    
    loadUsers();
});
</script>
{% endblock %}
